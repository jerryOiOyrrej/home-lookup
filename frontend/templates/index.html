<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ  Marseille Immo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen" x-data="app()" x-init="init()">

<!-- Header -->
<header class="bg-white shadow-sm border-b">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">ğŸ  Marseille Immo</h1>
            <p class="text-sm text-gray-500">Jerry & JoC ğŸª â€” Recherche d'appartement</p>
        </div>
        <div class="flex gap-4 items-center text-sm">
            <button @click="showAddModal = true" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm font-medium">â• Ajouter par URL</button>
        </div>
        <div class="flex gap-4 text-sm" x-show="stats">
            <div class="bg-blue-50 px-3 py-1 rounded-full">
                <span class="font-semibold" x-text="stats?.total || 0"></span> annonces
            </div>
            <div class="bg-green-50 px-3 py-1 rounded-full">
                Score moyen: <span class="font-semibold" x-text="stats?.score_moyen || '-'"></span>/100
            </div>
            <div class="bg-purple-50 px-3 py-1 rounded-full">
                Prix moyen: <span class="font-semibold" x-text="formatPrix(stats?.prix_moyen)"></span>
            </div>
        </div>
    </div>
</header>

<!-- Filtres -->
<div class="max-w-7xl mx-auto px-4 py-4">
    <div class="bg-white rounded-lg shadow-sm p-4 flex flex-wrap gap-4 items-end">
        <div>
            <label class="block text-xs font-medium text-gray-600 mb-1">Statut</label>
            <select x-model="filters.statut" @change="loadAnnonces()" class="rounded border-gray-300 text-sm">
                <option value="sans_ecarte">Tous (sauf Ã©cartÃ©s)</option>
                <option value="">Tous (y compris Ã©cartÃ©s)</option>
                <option value="nouveau">ğŸ†• Nouveau</option>
                <option value="interessant">â­ IntÃ©ressant</option>
                <option value="a_visiter">ğŸ“ Ã€ visiter</option>
                <option value="visite">âœ… VisitÃ©</option>
                <option value="offre">ğŸ’° Offre</option>
                <option value="ecarte">âŒ Ã‰cartÃ©</option>
            </select>
        </div>
        <div>
            <label class="block text-xs font-medium text-gray-600 mb-1">Arrondissement</label>
            <select x-model="filters.arrondissement" @change="loadAnnonces()" class="rounded border-gray-300 text-sm">
                <option value="">Tous</option>
                <option value="4e">4e</option>
                <option value="5e">5e</option>
                <option value="6e">6e</option>
                <option value="7e">7e</option>
                <option value="8e">8e</option>
            </select>
        </div>
        <div>
            <label class="block text-xs font-medium text-gray-600 mb-1">Prix max</label>
            <select x-model="filters.prix_max" @change="loadAnnonces()" class="rounded border-gray-300 text-sm">
                <option value="">Pas de limite</option>
                <option value="900000">900 000 â‚¬</option>
                <option value="1000000">1 000 000 â‚¬</option>
                <option value="1200000">1 200 000 â‚¬</option>
                <option value="1500000">1 500 000 â‚¬</option>
            </select>
        </div>
        <div>
            <label class="block text-xs font-medium text-gray-600 mb-1">Score min</label>
            <select x-model="filters.score_min" @change="loadAnnonces()" class="rounded border-gray-300 text-sm">
                <option value="">Tous</option>
                <option value="70">70+</option>
                <option value="60">60+</option>
                <option value="50">50+</option>
            </select>
        </div>
        <div>
            <label class="block text-xs font-medium text-gray-600 mb-1">Trier par</label>
            <select x-model="filters.sort_by" @change="loadAnnonces()" class="rounded border-gray-300 text-sm">
                <option value="score">Score</option>
                <option value="prix">Prix</option>
                <option value="surface_m2">Surface</option>
                <option value="prix_m2">Prix/mÂ²</option>
                <option value="first_seen_at">Date</option>
            </select>
        </div>
    </div>
</div>

<!-- Liste des annonces -->
<div class="max-w-7xl mx-auto px-4 pb-8">
    <div class="grid gap-4">
        <template x-for="a in annonces" :key="a.id">
            <div class="bg-white rounded-lg shadow-sm p-4 hover:shadow-md transition-shadow border-l-4"
                 :class="borderColor(a.score)">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-xs px-2 py-0.5 rounded-full font-medium"
                                  :class="statutBadge(a.statut)" x-text="statutLabel(a.statut)"></span>
                            <span class="text-xs text-gray-400" x-text="a.source"></span>
                            <span class="text-xs text-gray-400" x-text="a.arrondissement"></span>
                            <span class="text-xs text-gray-400" x-text="a.quartier"></span>
                        </div>
                        <h3 class="font-semibold text-gray-900" x-text="a.titre"></h3>
                        <div class="flex gap-4 mt-2 text-sm text-gray-600">
                            <span>ğŸ“ <span x-text="a.surface_m2"></span> mÂ²</span>
                            <span>ğŸ  <span x-text="a.nb_pieces"></span> piÃ¨ces</span>
                            <span x-show="a.nb_chambres">ğŸ› <span x-text="a.nb_chambres"></span> ch.</span>
                            <span x-show="a.terrasse">ğŸŒ¿ Terrasse</span>
                            <span x-show="a.cave">ğŸ“¦ Cave</span>
                            <span x-show="a.parking">ğŸ…¿ï¸ Parking</span>
                            <span x-show="a.ascenseur">ğŸ›— Ascenseur</span>
                            <span x-show="a.traversant">â†”ï¸ Traversant</span>
                        </div>
                        <p class="text-sm text-gray-500 mt-1 line-clamp-2" x-text="a.description"></p>
                        <!-- Contact -->
                        <div class="mt-2 flex gap-3 text-xs text-gray-500" x-show="a.contact_email || a.contact_telephone">
                            <span x-show="a.contact_email">ğŸ“§ <span x-text="a.contact_email"></span></span>
                            <span x-show="a.contact_telephone">ğŸ“ <span x-text="a.contact_telephone"></span></span>
                        </div>
                        <!-- Commentaire -->
                        <div class="mt-2" x-show="a.commentaire || a._editComment">
                            <div class="text-xs bg-gray-50 border border-gray-200 rounded p-2 text-gray-700 whitespace-pre-line" x-show="a.commentaire && !a._editComment" x-text="a.commentaire"></div>
                        </div>
                        <div class="mt-1" x-show="a._editComment">
                            <textarea class="w-full text-xs border rounded p-2" rows="2" x-model="a._commentDraft" placeholder="Ajouter un commentaire..."></textarea>
                            <div class="flex gap-1 mt-1">
                                <button @click="saveComment(a)" class="text-xs bg-blue-500 text-white px-2 py-0.5 rounded">ğŸ’¾</button>
                                <button @click="a._editComment = false" class="text-xs bg-gray-200 px-2 py-0.5 rounded">âœ•</button>
                            </div>
                        </div>
                        <div class="mt-2 flex gap-2" x-show="a.notes_perso">
                            <span class="text-xs bg-yellow-50 text-yellow-700 px-2 py-0.5 rounded">ğŸ“ <span x-text="a.notes_perso"></span></span>
                        </div>
                    </div>
                    <div class="text-right ml-4 flex-shrink-0">
                        <div class="text-xl font-bold text-gray-900" x-text="formatPrix(a.prix)"></div>
                        <div class="text-sm text-gray-500" x-text="formatPrix(a.prix_m2) + '/mÂ²'"></div>
                        <div class="mt-2 text-2xl font-bold" :class="scoreColor(a.score)">
                            <span x-text="a.score"></span><span class="text-sm">/100</span>
                        </div>
                    </div>
                </div>
                <!-- Actions -->
                <div class="flex gap-2 mt-3 pt-3 border-t">
                    <a :href="a.url" target="_blank" class="text-xs bg-blue-50 text-blue-700 px-3 py-1 rounded hover:bg-blue-100">ğŸ”— Voir l'annonce</a>
                    <button @click="updateStatut(a.id, 'interessant')" class="text-xs bg-green-50 text-green-700 px-3 py-1 rounded hover:bg-green-100">â­ IntÃ©ressant</button>
                    <button @click="updateStatut(a.id, 'a_visiter')" class="text-xs bg-purple-50 text-purple-700 px-3 py-1 rounded hover:bg-purple-100">ğŸ“ Ã€ visiter</button>
                    <button @click="a._editComment = true; a._commentDraft = a.commentaire || ''" class="text-xs bg-gray-50 text-gray-700 px-3 py-1 rounded hover:bg-gray-100">ğŸ’¬ Commenter</button>
                    <button @click="editContactPrompt(a)" class="text-xs bg-gray-50 text-gray-700 px-3 py-1 rounded hover:bg-gray-100">ğŸ“‡ Contact</button>
                    <button @click="ecarterPrompt(a.id)" class="text-xs bg-red-50 text-red-700 px-3 py-1 rounded hover:bg-red-100">âŒ Ã‰carter</button>
                </div>
            </div>
        </template>
    </div>

    <div x-show="annonces.length === 0" class="text-center py-12 text-gray-400">
        Aucune annonce trouvÃ©e. Lance une recherche ! ğŸ”
    </div>
</div>

<!-- Modal Ajouter par URL -->
<div x-show="showAddModal" x-cloak class="fixed inset-0 bg-black/40 flex items-center justify-center z-50" @click.self="showAddModal = false">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 p-6" @click.stop>
        <h2 class="text-lg font-bold mb-4">â• Ajouter une annonce</h2>
        <div class="space-y-3">
            <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">URL de l'annonce *</label>
                <input type="url" x-model="addForm.url" @input="detectSource()" placeholder="https://..." class="w-full border rounded-lg px-3 py-2 text-sm">
            </div>
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">Source</label>
                    <select x-model="addForm.source" class="w-full border rounded-lg px-3 py-2 text-sm">
                        <option value="bienici">Bien'ici</option>
                        <option value="seloger">SeLoger</option>
                        <option value="leboncoin">LeBonCoin</option>
                        <option value="pap">PAP</option>
                        <option value="figaro">Figaro</option>
                        <option value="barnes">Barnes</option>
                        <option value="autre">Autre</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">Type</label>
                    <select x-model="addForm.type_bien" class="w-full border rounded-lg px-3 py-2 text-sm">
                        <option value="appartement">Appartement</option>
                        <option value="maison">Maison</option>
                        <option value="duplex">Duplex</option>
                        <option value="loft">Loft</option>
                        <option value="autre">Autre</option>
                    </select>
                </div>
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">Titre *</label>
                <input type="text" x-model="addForm.titre" placeholder="T4 120mÂ² Vauban 6e" class="w-full border rounded-lg px-3 py-2 text-sm">
            </div>
            <div class="grid grid-cols-3 gap-3">
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">Prix (â‚¬) *</label>
                    <input type="number" x-model.number="addForm.prix" placeholder="950000" class="w-full border rounded-lg px-3 py-2 text-sm">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">Surface (mÂ²) *</label>
                    <input type="number" x-model.number="addForm.surface_m2" placeholder="120" class="w-full border rounded-lg px-3 py-2 text-sm">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">PiÃ¨ces *</label>
                    <input type="number" x-model.number="addForm.nb_pieces" placeholder="4" class="w-full border rounded-lg px-3 py-2 text-sm">
                </div>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">Chambres</label>
                    <input type="number" x-model.number="addForm.nb_chambres" placeholder="3" class="w-full border rounded-lg px-3 py-2 text-sm">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">Arrondissement</label>
                    <select x-model="addForm.arrondissement" class="w-full border rounded-lg px-3 py-2 text-sm">
                        <option value="">â€”</option>
                        <option value="4e">4e</option>
                        <option value="5e">5e</option>
                        <option value="6e">6e</option>
                        <option value="7e">7e</option>
                        <option value="8e">8e</option>
                    </select>
                </div>
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">Description</label>
                <textarea x-model="addForm.description" rows="2" placeholder="Optionnel..." class="w-full border rounded-lg px-3 py-2 text-sm"></textarea>
            </div>
            <div class="flex flex-wrap gap-4 text-sm">
                <label class="flex items-center gap-1"><input type="checkbox" x-model="addForm.terrasse"> ğŸŒ¿ Terrasse</label>
                <label class="flex items-center gap-1"><input type="checkbox" x-model="addForm.cave"> ğŸ“¦ Cave</label>
                <label class="flex items-center gap-1"><input type="checkbox" x-model="addForm.parking"> ğŸ…¿ï¸ Parking</label>
                <label class="flex items-center gap-1"><input type="checkbox" x-model="addForm.ascenseur"> ğŸ›— Ascenseur</label>
                <label class="flex items-center gap-1"><input type="checkbox" x-model="addForm.traversant"> â†”ï¸ Traversant</label>
            </div>
        </div>
        <div class="flex justify-end gap-2 mt-5">
            <button @click="showAddModal = false" class="px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg">Annuler</button>
            <button @click="submitAdd()" :disabled="addLoading" class="px-4 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50">
                <span x-show="!addLoading">Ajouter</span>
                <span x-show="addLoading">â³ Ajout...</span>
            </button>
        </div>
        <div x-show="addError" class="mt-3 text-sm text-red-600 bg-red-50 p-2 rounded" x-text="addError"></div>
        <div x-show="addSuccess" class="mt-3 text-sm text-green-600 bg-green-50 p-2 rounded" x-text="addSuccess"></div>
    </div>
</div>

<script>
function app() {
    return {
        annonces: [],
        stats: null,
        showAddModal: false,
        addLoading: false,
        addError: '',
        addSuccess: '',
        addForm: {
            url: '', source: 'autre', type_bien: 'appartement', titre: '',
            prix: null, surface_m2: null, nb_pieces: null, nb_chambres: null,
            arrondissement: '', description: '',
            terrasse: false, cave: false, parking: false, ascenseur: false, traversant: false,
        },
        filters: {
            statut: 'sans_ecarte',
            arrondissement: '',
            prix_max: '',
            score_min: '',
            sort_by: 'score',
        },

        async init() {
            await this.loadAnnonces();
            await this.loadStats();
        },

        async loadAnnonces() {
            const params = new URLSearchParams();
            if (this.filters.statut && this.filters.statut !== 'sans_ecarte') params.set('statut', this.filters.statut);
            if (this.filters.statut === 'sans_ecarte') params.set('exclude_ecarte', 'true');
            if (this.filters.arrondissement) params.set('arrondissement', this.filters.arrondissement);
            if (this.filters.prix_max) params.set('prix_max', this.filters.prix_max);
            if (this.filters.score_min) params.set('score_min', this.filters.score_min);
            if (this.filters.sort_by) params.set('sort_by', this.filters.sort_by);
            params.set('sort_order', 'desc');

            const res = await fetch(`/api/annonces?${params}`);
            const data = await res.json();
            this.annonces = data.annonces;
        },

        async loadStats() {
            const res = await fetch('/api/stats');
            this.stats = await res.json();
        },

        async updateStatut(id, statut) {
            await fetch(`/api/annonces/${id}`, {
                method: 'PATCH',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ statut }),
            });
            await this.loadAnnonces();
            await this.loadStats();
        },

        async saveComment(a) {
            await fetch(`/api/annonces/${a.id}`, {
                method: 'PATCH',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ commentaire: a._commentDraft }),
            });
            a.commentaire = a._commentDraft;
            a._editComment = false;
        },

        async editContactPrompt(a) {
            const email = prompt('Email de contact :', a.contact_email || '');
            if (email === null) return;
            const tel = prompt('TÃ©lÃ©phone de contact :', a.contact_telephone || '');
            if (tel === null) return;
            await fetch(`/api/annonces/${a.id}`, {
                method: 'PATCH',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ contact_email: email || null, contact_telephone: tel || null }),
            });
            a.contact_email = email || null;
            a.contact_telephone = tel || null;
        },

        async ecarterPrompt(id) {
            const raison = prompt('Raison ?');
            if (raison) {
                await fetch(`/api/annonces/${id}/ecarter?raison=${encodeURIComponent(raison)}`, { method: 'POST' });
                await this.loadAnnonces();
                await this.loadStats();
            }
        },

        detectSource() {
            const u = this.addForm.url.toLowerCase();
            if (u.includes('bienici')) this.addForm.source = 'bienici';
            else if (u.includes('seloger')) this.addForm.source = 'seloger';
            else if (u.includes('leboncoin')) this.addForm.source = 'leboncoin';
            else if (u.includes('pap.fr')) this.addForm.source = 'pap';
            else if (u.includes('figaro') || u.includes('bellesdemeures')) this.addForm.source = 'figaro';
            else if (u.includes('barnes')) this.addForm.source = 'barnes';
            else this.addForm.source = 'autre';
        },

        async submitAdd() {
            this.addError = '';
            this.addSuccess = '';
            if (!this.addForm.url || !this.addForm.titre || !this.addForm.prix || !this.addForm.surface_m2 || !this.addForm.nb_pieces) {
                this.addError = 'Remplis au moins : URL, titre, prix, surface et nb piÃ¨ces.';
                return;
            }
            this.addLoading = true;
            try {
                const body = {
                    url: this.addForm.url,
                    source: this.addForm.source,
                    type_bien: this.addForm.type_bien,
                    titre: this.addForm.titre,
                    prix: this.addForm.prix,
                    surface_m2: this.addForm.surface_m2,
                    nb_pieces: this.addForm.nb_pieces,
                };
                if (this.addForm.nb_chambres) body.nb_chambres = this.addForm.nb_chambres;
                if (this.addForm.arrondissement) body.arrondissement = this.addForm.arrondissement;
                if (this.addForm.description) body.description = this.addForm.description;
                if (this.addForm.terrasse) body.terrasse = true;
                if (this.addForm.cave) body.cave = true;
                if (this.addForm.parking) body.parking = true;
                if (this.addForm.ascenseur) body.ascenseur = true;
                if (this.addForm.traversant) body.traversant = true;

                const res = await fetch('/api/annonces', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body),
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.detail || 'Erreur serveur');
                this.addSuccess = data.status === 'updated' ? 'ğŸ”„ Annonce mise Ã  jour !' : 'âœ… Annonce ajoutÃ©e !';
                await this.loadAnnonces();
                await this.loadStats();
                // Reset form after short delay
                setTimeout(() => {
                    this.showAddModal = false;
                    this.addSuccess = '';
                    this.addForm = {
                        url: '', source: 'autre', type_bien: 'appartement', titre: '',
                        prix: null, surface_m2: null, nb_pieces: null, nb_chambres: null,
                        arrondissement: '', description: '',
                        terrasse: false, cave: false, parking: false, ascenseur: false, traversant: false,
                    };
                }, 1500);
            } catch (e) {
                this.addError = e.message;
            } finally {
                this.addLoading = false;
            }
        },

        formatPrix(prix) {
            if (!prix) return '-';
            return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(prix);
        },

        scoreColor(score) {
            if (score >= 70) return 'text-green-600';
            if (score >= 50) return 'text-yellow-600';
            return 'text-red-500';
        },

        borderColor(score) {
            if (score >= 70) return 'border-green-400';
            if (score >= 50) return 'border-yellow-400';
            return 'border-red-300';
        },

        statutBadge(statut) {
            const map = {
                nouveau: 'bg-blue-100 text-blue-700',
                interessant: 'bg-green-100 text-green-700',
                a_visiter: 'bg-purple-100 text-purple-700',
                visite: 'bg-teal-100 text-teal-700',
                offre: 'bg-yellow-100 text-yellow-700',
                ecarte: 'bg-red-100 text-red-700',
            };
            return map[statut] || 'bg-gray-100 text-gray-700';
        },

        statutLabel(statut) {
            const map = {
                nouveau: 'ğŸ†• Nouveau',
                interessant: 'â­ IntÃ©ressant',
                a_visiter: 'ğŸ“ Ã€ visiter',
                visite: 'âœ… VisitÃ©',
                offre: 'ğŸ’° Offre',
                ecarte: 'âŒ Ã‰cartÃ©',
            };
            return map[statut] || statut;
        },
    }
}
</script>
</body>
</html>
